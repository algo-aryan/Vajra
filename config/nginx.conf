worker_processes  1;
error_log  logs/error.log;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    lua_package_path "/Users/aryanbansal/.luarocks/share/lua/5.1/?.lua;;";
    lua_package_cpath "/Users/aryanbansal/.luarocks/lib/lua/5.1/?.so;;";

    server {
        listen       10101;
        server_name  localhost;
        root /Users/aryanbansal/vajra-mcd;

        location / {
            index portal/index.html;
        }

        location /portal/ {
            alias /Users/aryanbansal/vajra-mcd/portal/;
        }

        location /api/v1/telemetry {
            # --- START CORS FIX ---
            add_header 'Access-Control-Allow-Origin' 'http://localhost:8080' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://localhost:8080' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }
            # --- END CORS FIX ---

            default_type application/json;
            content_by_lua_block {
                local args = ngx.req.get_uri_args()
                local hwid = args.hwid or "NONE"
                local ip = ngx.var.remote_addr
                if ip == "::1" then ip = "127.0.0.1" end
                
                local log_path = "/Users/aryanbansal/vajra-mcd/portal/vault/intruder_alerts.log"
                local file, err = io.open(log_path, "a")
                
                if file then
                    file:write(string.format("[%s] HWID_CAPTURED | IP: %s | ID: %s\n", os.date("%Y-%m-%d %H:%M:%S"), ip, hwid))
                    file:flush()
                    file:close()
                    ngx.say('{"status": "recorded"}')
                else
                    ngx.log(ngx.ERR, "LOGGING FAILURE: ", err)
                    ngx.status = 500
                end
            }
        }

        location /api/v1/search {
            # --- START CORS FIX ---
            add_header 'Access-Control-Allow-Origin' 'http://localhost:8080' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'http://localhost:8080' always;
                return 204;
            }
            # --- END CORS FIX ---

            default_type application/json;
            content_by_lua_block {
                local status, err = pcall(function()
                    local sqlite3 = require "lsqlite3complete"
                    local args = ngx.req.get_uri_args()
                    local pid = (args.pid or ""):gsub("%s+", "")
                    
                    local is_hack = pid:match("['\"%;]") or pid:lower():match("or%s+1=1") or pid:lower():match("union")                    
                    local db_path, query
                    if is_hack then
                        db_path = "/Users/aryanbansal/vajra-mcd/database/mcd_shadow_vault.db"
                        query = "SELECT * FROM property_records LIMIT 5000"
                    else
                        db_path = "/Users/aryanbansal/vajra-mcd/database/mcd_production.db"
                        query = "SELECT * FROM property_records WHERE property_id = '" .. pid .. "'"
                    end

                    local db = sqlite3.open(db_path)
                    local results = {}
                    for row in db:nrows(query) do table.insert(results, row) end
                    
                    local cjson = require "cjson"
                    ngx.say(cjson.encode(results))
                    db:close()
                end)
                if not status then
                    ngx.status = 500
                    ngx.say('{"error": "SERVER_LOGGED_EXCEPTION"}')
                end
            }
        }
    }
}